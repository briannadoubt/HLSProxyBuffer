# Alternate Renditions

The proxy now understands `#EXT-X-MEDIA` declarations for audio, subtitle, and closed-caption tracks. Master manifests parsed by `HLSParser` produce `HLSManifest.Rendition` models that capture type, group identifiers, languages, selection flags, and fully resolved URIs. Malformed tags (for example, missing a `GROUP-ID` or `URI` on an audio track) throw `ParserError.missingMediaAttribute` so invalid playlists fail fast.

## Rewriting & Routing

`HLSRewriter` rewrites each media playlist (video or rendition) to proxy-safe URLs. Rendition playlists receive their own namespace so audio/subtitle segment keys never collide with the primary video cache. `ProxyRouter` now serves:

- `/playlist.m3u8` – the master playlist generated by `ProxyHLSPlayer` containing `#EXT-X-MEDIA` rows and the active variant.
- `/variants/main.m3u8` – the rewritten media playlist consumed by AVPlayer.
- `/renditions/<rendition-id>.m3u8` – rewritten alternate playlists, each referencing `/segments/<namespaced-key>`.

`/debug/status` reports `active_audio_rendition` and `active_subtitle_rendition`, making it easy to confirm runtime selections.

## ProxyHLSPlayer API

`ProxyHLSPlayer` exposes new `@Published` collections:

- `audioRenditions` / `subtitleRenditions`: Parsed `HLSManifest.Rendition` values whose `uri` points at proxy endpoints.
- `activeAudioRendition` / `activeSubtitleRendition`: Currently selected tracks.

Use `selectRendition(kind:id:)` to switch tracks without recreating `AVPlayer`. The player updates AVFoundation media selection groups, rewrites the master playlist so diagnostics reflect the change, and fires `ProxyPlayerDiagnostics.onRenditionChanged`.

## Auxiliary Assets

Applications can register custom audio or subtitle assets and surface them as renditions:

```swift
let subtitles = Data("""
WEBVTT

00:00.000 --> 00:02.000
Hello!
""".utf8)

let registration = AuxiliaryRenditionRegistration(
    kind: .subtitles,
    groupId: "subs-offline",
    name: "Offline CC",
    language: "en",
    isDefault: false,
    isAutoSelect: true
)

await player.registerAuxiliaryAsset(
    data: subtitles,
    identifier: "offline-cc",
    type: .subtitles,
    rendition: registration
)
```

The proxy hosts the payload under `/assets/subtitles/offline-cc` and adds a matching `#EXT-X-MEDIA` entry to the master playlist during the next load. If the registration type mismatches the rendition kind (e.g., `.audio` data with a `.subtitles` descriptor) the player logs a warning and skips the mapping.

## Error Handling

- Parser errors clearly name the missing attribute, e.g., `EXT-X-MEDIA tag is missing required attribute URI`.
- Rendition playlist rewrites log failures and fall back to the source URI if an upstream playlist cannot be parsed.
- Auxiliary registrations keep the data available even if a rendition descriptor is invalid; a log warning describes the mismatch so the caller can correct it.
